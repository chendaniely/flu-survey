---
title: "analysis draft"
output: 
  html_document:
    fig_caption: yes
    fig_height: 3
    fig_width: 6
    keep_md: yes
    theme: paper
    toc: yes
    toc_depth: 2
  html_notebook: 
    fig_caption: yes
    toc: yes
    toc_depth: 2
  pdf_document: 
    fig_caption: yes
    keep_tex: yes
    toc: yes
    toc_depth: 2
editor_options: 
  chunk_output_type: inline
---

Q13. Do you get the flu vaccine?  
Q14. How much do you pay to get an influenza vaccine?  
Q15. Are you more likely to get a vaccine if others around you get a vaccine?  
Q16. Are you more likely to get a vaccine if others around you do not get a vaccine?  
Q17. Do you get a vaccine to protect yourself, protect others, or protect yourself and others?  
Q18. What are the reasons you would not get an influenza vaccine? 
Q19. Do you have health insurance?  
Q20. How effective do you think the influenza vaccine is in protecting people from becoming sick with influenza? 
Q21. Are influenza vaccines covered by your insurance? 

```{r setup}
knitr::opts_chunk$set(echo = T, cache = T, warning = F, message = F, tidy = T, size = "small")
rm(list = ls(all.names = TRUE))

library(dplyr)
library(ggplot2)
library(gridExtra)
library(knitr)
library(rmarkdown)
library(survey)
library(tidyr)

## flu-survey/code/data_prep.R
load("~/git/flu-survey/data/data_prep.RData")

## subset columns
df <- dataf[, c(1,4:27, 28:33, 92:111, 429)]
names(df)
```

```{r recode-data}
## recode variables
library(car)

## use code function for response variables
## reset the "default" level on categorical variables
code <- function(col, map, ref) {
  relevel(as.factor(map[col]), ref=ref)
}

## income - PPINCIMP
income.map <- c(rep("under $10k", 3),
                rep("$10k to $25k", 4),
                rep("$25k to $50k", 4),
                rep("$50k to $75k", 2),
                rep("$75k to $100k", 2),
                rep("$100k to $150k", 2),
                rep("over $150k", 2))
df$income <- code(dataf$PPINCIMP, income.map, "under $10k")
income.lab <- c("under $10k", "$10k to $25k", "$25k to $50k", "$50k to $75k", "$75k to $100k", "$100k to $150k", "over $150k")
df$income <- factor(df$income, levels = income.lab)

## marital status - PPMARIT
marital.map <- c("single", "partnered", "partnered", "single", "single", "single")
df$marital <- code(dataf$PPMARIT, marital.map, "single")

## employment status - PPWORK
work.map <- c(rep("unemployed", 5),
              rep("employed", 2))
df$work <- code(dataf$PPWORK, work.map, "unemployed")

## check columns
colnames(df)
```

```{r ggplot}
## ggplot templates
ptext <- theme(axis.text = element_text(size = rel(0.9)), axis.text.x = element_text(angle = 45, hjust = 1))
ptext2 <- ptext + theme(axis.text.x = element_blank())
```

```{r survey-des}
## create survey object
options(digits = 4)
options(survey.lonely.psu = "adjust")
des <- svydesign(ids = ~1, weights = ~weight, data = df[is.na(df$weight)==F, ])
```



# Regression model

```{r}
# Q13
library(MASS)
library(broom)

# need to remove NA's
df2 <- df[!is.na(df$Q13) & !is.na(df$Q18_1:df$Q18_9), ]
nrow(df2)

# drop unused factor first?
# model
m <- polr(Q13 ~ Q18_1, weights = df2$weight, data = df2, Hess=TRUE)
summary(m)

#exp(m$coefficients)
#coef(summary(m))

danresults <- tidy(coef(summary(m)))
danresults$OR <- exp(danresults$Value)
danresults$ORupper <- exp(danresults$Value + 1.96*danresults$Std..Error)
danresults$ORlower <- exp(danresults$Value - 1.96*danresults$Std..Error)
danresults
```


