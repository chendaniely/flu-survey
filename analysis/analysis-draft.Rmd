---
title: "analysis draft"
output: 
  html_document:
    fig_caption: yes
    fig_height: 3
    fig_width: 5
    theme: paper
    keep_md: yes
    toc: yes
    toc_depth: 2
---

Questions 13-21.

```{r setup}
knitr::opts_chunk$set(echo = T, cache = T, warning = F, message = F, tidy = T, size = "small")
rm(list = ls(all.names = TRUE))

library(dplyr)
library(ggplot2)
library(gridExtra)
library(knitr)
library(rmarkdown)
library(survey)
library(tidyr)
```

```{r load-data}
## flu-survey/code/data_prep.R
load("~/git/flu-survey/data/data_prep.RData")

## create copy of factored data
df <- dataf
```

```{r recode-data}
## recode variables
library(car)

## use code function for response variables
## reset the "default" level on categorical variables
code <- function(col, map, ref) {
  relevel(as.factor(map[col]), ref=ref)
}

## income - PPINCIMP
income.map <- c(rep("under $10k", 3),
                rep("$10k to $25k", 4),
                rep("$25k to $50k", 4),
                rep("$50k to $75k", 2),
                rep("$75k to $100k", 2),
                rep("$100k to $150k", 2),
                rep("over $150k", 2))
df$income <- code(dataf$PPINCIMP, income.map, "under $10k")
income.lab <- c("under $10k", "$10k to $25k", "$25k to $50k", "$50k to $75k", "$75k to $100k", "$100k to $150k", "over $150k")
df$income <- factor(df$income, levels = income.lab)

## marital status - PPMARIT
marital.map <- c("single", "partnered", "partnered", "single", "single", "single")
df$marital <- code(dataf$PPMARIT, marital.map, "single")

## employment status - PPWORK
work.map <- c(rep("unemployed", 5),
              rep("employed", 2))
df$work <- code(dataf$PPWORK, work.map, "unemployed")
```

```{r ggplot}
## create ggplot templates
ptext <- theme(axis.text = element_text(size = rel(0.9)), axis.text.x = element_text(angle = 45, hjust = 1))
ptext2 <- ptext + theme(axis.text.x = element_blank())

# pgen <- aes(PPGENDER)
# page <- aes(ppagect4)
# peth <- aes(PPETHM)
# pinc <- aes(income)
# pedu <- aes(PPEDUCAT)
# pwor <- aes(work)
# pmar <- aes(marital)

```

```{r survey-design}
## create survey object
options(digits = 4)
options(survey.lonely.psu = "adjust")

des <- svydesign(ids = ~1, weights = ~weight, data = df[is.na(df$weight)==F, ])
```


## Q13. Do you get the flu vaccine?

```{r}
q13 <- as.data.frame(svytable(~Q13 + PPGENDER + ppagect4 + PPETHM + income + PPEDUCAT + work + marital, des, round = T))
title <- ggtitle("Q13. Do you get the flu vaccine?")
p <- ggplot(q13, aes(Q13, weight = Freq)) + ptext
p + geom_bar() + title
```

```{r}
### EXAMPLE ###

# chi-square for Q13 and gender
svychisq(~Q13 + PPGENDER, des)

# table: Q13 by gender
q <- svyby(~Q13, ~PPGENDER, des, svymean, na.rm = T)
names(q)

# plot
er <- geom_errorbar(aes(ymin = q[4] - q[7],
                        ymax = q[4] + q[7]), width = .25)
ggplot(q, aes(PPGENDER, q[4])) + geom_point() + xlab("") + ylab("Q13No, never") + er + ggtitle(label = "") 
```



```{r}
### chi-square for Q13

svychisq(~Q13 + ppagecat, des)
svychisq(~Q13 + ppagect4, des)
svychisq(~Q13 + PPEDUC, des)
svychisq(~Q13 + PPEDUCAT, des)
svychisq(~Q13 + PPETHM, des)
#svychisq(~Q13 + PPGENDER, des)
#svychisq(~Q13 + PPHHHEAD, des)
svychisq(~Q13 + PPHOUSE, des)
svychisq(~Q13 + income, des)
svychisq(~Q13 + marital, des)
svychisq(~Q13 + PPMSACAT, des)
svychisq(~Q13 + PPREG4, des)
svychisq(~Q13 + ppreg9, des)
svychisq(~Q13 + PPRENT, des)
#svychisq(~Q13 + PPSTATEN, des)
#svychisq(~Q13 + PPT01, des)
#svychisq(~Q13 + PPT25, des)
#svychisq(~Q13 + PPT612, des)
#svychisq(~Q13 + PPT1317, des)
#svychisq(~Q13 + PPT18OV, des)
svychisq(~Q13 + PPWORK, des)
svychisq(~Q13 + PPNET, des)
```

Significant variables for Q13:
Age, education, ethnicity, housing type, income, marital status, metro status, region, rental status, employment status, internet status


```{r}
# table: Q13 by age
q <- svyby(~Q13, ~ppagecat, des, svymean, na.rm = T)
q

# plot: Yes, every year
er <- geom_errorbar(aes(ymin = q[2] - q[5],
                        ymax = q[2] + q[5]), width = .25)
ggplot(q, aes(ppagecat, q[2])) + geom_point() + xlab("") + ylab("Q13Yes, every year") + er + ggtitle(label = "") 
```

```{r}
svychisq(~Q13 + ppagect4, des)

# table: Q13 by age (cat4)
q <- svyby(~Q13, ~ppagect4, des, svymean, na.rm = T)
q

# plot: Yes, every year
er <- geom_errorbar(aes(ymin = q[2] - q[5],
                        ymax = q[2] + q[5]), width = .25)
ggplot(q, aes(ppagect4, q[2])) + geom_point() + xlab("") + ylab("Q13Yes, every year") + er + ggtitle(label = "") 
```

```{r}

```


## Q14. How much do you pay to get an influenza vaccine?

```{r}
q14 <- as.data.frame(svytable(
  ~Q14 + PPGENDER + ppagect4 + PPETHM + income + PPEDUCAT + work + marital, des, round = T))

title <- ggtitle("Q14. How much do you pay to get an influenza vaccine?")
p <- ggplot(q14, aes(Q14, weight = Freq)) + ptext
p + geom_bar() + title

```

```{r}

```



## Q15. Are you more likely to get a vaccine if others around you get a vaccine?

```{r}
# chisquare
svychisq(~Q15 + Q2, des)

q15 <- as.data.frame(svytable(
  ~Q15 + PPGENDER + ppagect4 + PPETHM + income + PPEDUCAT + work + marital, des, round = T))

title <- ggtitle("Q15. Are you more likely to get a vaccine if others around you get a vaccine?")
p <- ggplot(q15, aes(Q15, weight = Freq)) + ptext
p + geom_bar() + title


```

```{r}

```



## Q16. Are you more likely to get a vaccine if others around you do not get a vaccine?

```{r}
# chisquare
svychisq(~Q16 + Q2, des)

q16 <- as.data.frame(svytable(
  ~Q16 + PPGENDER + ppagect4 + PPETHM + income + PPEDUCAT + work + marital, des, round = T))

title <- ggtitle("Q16. Are you more likely to get a vaccine if others around you do not get a vaccine?")
p <- ggplot(q16, aes(Q16, weight = Freq)) + ptext
fil <- aes(fill = Q16)

p + geom_bar() + title
# gen <- p + pgen + fil + geom_bar(position = "dodge") + title
# age <- p + page + fil + geom_bar(position = "dodge")
# eth <- p + peth + fil + geom_bar(position = "dodge") + coord_flip()
# inc <- p + pinc + fil + geom_bar(position = "dodge") + title
# edu <- p + pedu + fil + geom_bar(position = "dodge") + title
# wor <- p + pwor + fil + geom_bar(position = "dodge")
# mar <- p + pmar + fil + geom_bar(position = "dodge")
# 
# grid.arrange(gen, age, eth)
# grid.arrange(inc, edu, wor, mar)

```


## Q17. Do you get a vaccine to protect yourself, protect others, or protect yourself and others?

```{r}
q17 <- as.data.frame(svytable(
  ~Q17 + PPGENDER + ppagect4 + PPETHM + income + PPEDUCAT + work + marital, des, round = T))

title <- ggtitle("Q17. Do you get a vaccine to protect yourself, protect others, or protect yourself and others?")
p <- ggplot(q17, aes(Q17, weight = Freq)) + ptext
p + geom_bar() + title


```

```{r}

```



## Q18. What are the reasons you would not get an influenza vaccine?

```{r}


title <- ggtitle("Q18. What are the reasons you would not get an influenza vaccine?")


```


## Q19. Do you have health insurance?

```{r}
# chisquare
svychisq(~Q19 + Q2, des)

q19 <- as.data.frame(svytable(
  ~Q19 + PPGENDER + ppagect4 + PPETHM + income + PPEDUCAT + work + marital, des, round = T))

title <- ggtitle("Q19. Do you have health insurance?")
p <- ggplot(q19, aes(Q19, weight = Freq)) + ptext
p + geom_bar() + title

## sick plot
q <- svyby(~Q2, ~Q19, des, svymean, na.rm = T)
ggplot(q, aes(Q19, Q2Yes)) + geom_point() + xlab(" ") + ylab("% sick") + er +
  ggtitle(label = "% of adults sick and having health insurance ") 

```


## Q20. How effective do you think the influenza vaccine is in protecting people from becoming sick with influenza?

```{r}
q20 <- as.data.frame(svytable(
  ~Q20 + PPGENDER + ppagect4 + PPETHM + income + PPEDUCAT + work + marital, des, round = T))

title <- ggtitle("Q20. How effective do you think the influenza vaccine is in protecting people from becoming sick with influenza?")
p <- ggplot(q20, aes(Q20, weight = Freq)) + ptext
p + geom_bar() + title

## sick plot
svychisq(~Q2 + Q20, des)
q <- svyby(~Q2, ~Q20, des, svymean, na.rm = T)
ggplot(q, aes(Q20, Q2Yes)) + geom_point() + xlab(" ") + ylab("% sick") + ptext + er +
  ggtitle(label = "% of adults sick vs. perception of flu vaccine efficacy") 

```


## Q21. Are influenza vaccines covered by your insurance?

```{r}
q21 <- as.data.frame(svytable(
  ~Q21 + PPGENDER + ppagect4 + PPETHM + income + PPEDUCAT + work + marital, des, round = T))

title <- ggtitle("Q21. Are influenza vaccines covered by your health insurance?")
p <- ggplot(q21, aes(Q21, weight = Freq)) + ptext
p + geom_bar() + title

```



### Q13. Do you get the flu vaccine?

### Q14. How much do you pay to get an influenza vaccine?

### Q15. Are you more likely to get a vaccine if others around you get a vaccine?

### Q16. Are you more likely to get a vaccine if others around you do not get a vaccine?

### Q17. Do you get a vaccine to protect yourself, protect others, or protect yourself and others?

### Q18. What are the reasons you would not get an influenza vaccine?

### Q19. Do you have health insurance?

### Q20. How effective do you think the influenza vaccine is in protecting people from becoming sick with influenza?

### Q21. Are influenza vaccines covered by your insurance?


