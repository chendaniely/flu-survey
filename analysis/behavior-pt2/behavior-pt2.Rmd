---
title: "Behavior part 2: Perceived risk"
output: 
  html_document:
    fig_caption: yes
    keep_md: yes
    theme: paper
    toc: yes
    toc_depth: 2
---

Questions 11, 20.
Perceived risk.

```{r setup, include=F}
## Setup.

knitr::opts_chunk$set(echo = F, cache = T, warning = F, message = F, size = "small")
rm(list = ls(all.names = T))
library(rmarkdown); library(knitr); library(gridExtra)
library(tidyr); library(dplyr); library(ggplot2); library(survey)
```

```{r load-data, include=F}
## Load data.

load("~/git/flu-survey/data/cleaning2.RData")
load("~/git/flu-survey/data/recoding.RData")  # load "datar"
df <- datar  # recoded variables
```

```{r group-data, include=F}
## Regroup variables.

# income
income.map <- c(rep("under $10k", 3), rep("$10k to $25k", 4),
                rep("$25k to $50k", 4), rep("$50k to $75k", 2),
                rep("$75k to $100k", 2), rep("$100k to $150k", 2),
                rep("over $150k", 2))
df$income <- code(datar$PPINCIMP, income.map, "under $10k")
income.lab <- c("under $10k", "$10k to $25k", "$25k to $50k",
                "$50k to $75k", "$75k to $100k", "$100k to $150k",
                "over $150k")
df$income <- factor(df$income, levels = income.lab)

# marital staus
marital.map <- c("single", "partnered", "partnered", "single", "single", "single")
df$marital <- code(dataf$PPMARIT, marital.map, "single")

# work status
work.map <- c(rep("unemployed", 5),
              rep("employed", 2))
df$work <- code(dataf$PPWORK, work.map, "unemployed")
```

```{r des-survey}
## Create survey object.

options(digits = 4)
options(survey.lonely.psu = "adjust")

des <- svydesign(ids = ~1, weights = ~weight, data = df[is.na(df$weight)==F, ])
```

```{r plot-temp, include=F}
## Create ggplot templates.

ptext <- theme(axis.text = element_text(size = rel(0.9)),
               axis.text.x = element_text(angle = 45, hjust = 1))

```



## Q11. How do you rate your risk of getting influenza if you visited each of the following locations?

```{r q11-data}
# subset question data, rename columns, gather into single column
q11_df <- df %>%
  select(CaseID, PPGENDER, PPAGE, ppagecat, PPETHM, PPINCIMP, PPEDUC, PPEDUCAT,
         work, marital, PPMSACAT, ppreg9, PPSTATEN, PPHOUSE, PPNET,
         Q11_1:Q11_11, weight) %>%
  rename(Work = Q11_1,
         Schools = Q11_2,
         Day_care = Q11_3,
         Stores = Q11_4,
         Restaurants = Q11_5,
         Libraries = Q11_6,
         Hospitals = Q11_7,
         Doctors_office = Q11_8,
         Public_trans = Q11_9,
         Family_friends = Q11_10,
         Other = Q11_11) %>%
  gather(Q11_q, Q11_r, Work:Other, na.rm = T) %>%
  mutate(Q11_q = as.factor(Q11_q))

# survey design
des11 <- svydesign(ids = ~1, weights = ~weight, data = q11_df[is.na(q11_df$weight)==F, ])
```

Gender, age, ethnicity, income, education

```{r}
# weighted data frame
q11 <- data.frame(svytable(~Q11_q + Q11_r + PPGENDER + ppagecat + PPETHM +
                            PPINCIMP + PPEDUC + PPEDUCAT , des11, round = T))

# plot templates
title <- ggtitle("How do you rate your risk of getting influenza if you visited each of the following locations?")
p <- ggplot(q11[q11$Q11_r != "Don_t Know",], aes(Q11_q, weight = Freq)) + ptext

# select High Risk
p <- ggplot(q11[q11$Q11_r == "High Risk",], aes(Q11_q, weight = Freq)) + ptext


# main plot
p + geom_bar(position = "fill") + aes(Q11_q, fill = Q11_r)

```


```{r}
# update survey design to select 'High Risk'
des11_high <- svydesign(ids = ~1, weights = ~weight, data = q11_df[is.na(q11_df$weight)==F, ])

```


############## FIX THIS PART!!!

```{r}
# weighted data frame
q11 <- data.frame(svytable(~Work + Schools + Day_care + Stores + Restaurants +
                             Libraries + Hospitals + Doctors_office + Public_trans +
                             Family_friends + Other, des11, round = T))
# plot templates
title <- ggtitle("How do you rate your risk of getting influenza if you visited each of the following locations?")
p <- ggplot(q11, aes(weight = Freq)) + ptext

# main plot
p + geom_bar() + aes(Q11_q, fill = Q11_r)


# subset high risk group
sub <- q11[(q11$Q11_r)=='High Risk', ]
str(sub)
p1 <- ggplot(sub, aes(Q11_q, weight = Freq))

p1 + geom_bar()

p1 <- ggplot(q11[(q11$Q11_r)=='High Risk', ], aes(Q11_q, weight = Freq))
p1 + geom_bar() + aes(fill = Q11_r)

# select responses
# q11_df <- q11_df[(q11_df$Q11_r)=='High Risk', ]

# main plot for High Risk
p <- ggplot(q11[(q11$Q11_r)=='High Risk', ], aes(Q11_q, weight = Freq)) + ptext


```

```{r}
# exclude "Other" choice
p2 <- ggplot(q11[!(q11$Q11_q)=='Other', ], aes(Q11_q, weight = Freq)) + ptext

# by gender
p2 + geom_bar() + aes(PPGENDER, fill = PPGENDER) + facet_wrap(~Q11_q) + ggtitle("By gender")

# by age group
p2 + geom_bar() + aes(ppagecat, fill = ppagecat) + facet_wrap(~Q11_q) + ggtitle("By age group")
p2 + geom_bar(position = "fill") + aes(ppagecat, fill = Q11_q)

# by ethnic group
p + geom_bar() + aes(PPETHM, fill = PPETHM) + facet_wrap(~Q11_q) +
  ggtitle("By ethnic group") + theme(axis.text.x = element_blank())
p + geom_bar() + aes(fill = Q11_q) + facet_grid(~PPETHM) +
  ggtitle("By ethnic group")

# by income
p + geom_bar() + aes(PPINCIMP, fill = PPINCIMP) + facet_grid(~Q11_q) +
  ggtitle("By income") + theme(axis.text.x = element_blank())

# by education
```

Employment status, marital status, metro status, region, state of residency, housing status, internet availability

```{r}
# weighted data frame
q11 <- data.frame(svytable(~Q11_q + Q11_r + work + marital + PPMSACAT +
                            ppreg9 + PPSTATEN + PPHOUSE + PPNET, des11, round = T))
# p and p2
p <- ggplot(q11[(q11$Q11_r)=='Yes', ], aes(Q11_q, weight = Freq)) + ptext
p2 <- ggplot(q11[!(q11$Q11_q)=='Other', ], aes(Q11_q, weight = Freq)) + ptext
```

```{r}
# by work
p + geom_bar() + aes(work, fill = work) + facet_wrap(~Q11_q) + ggtitle("By employment status")

# by marital
p + geom_bar() + aes(marital, fill = marital) + facet_wrap(~Q11_q) + ggtitle("By marital status")
p + geom_bar(position = "fill") + aes(marital, fill = Q11_q)

# by metro status
p + geom_bar(position = "fill") + aes(fill = PPMSACAT) + ggtitle("By metro status")

# by region
p + geom_bar() + aes(fill = ppreg9) + ggtitle("By region")

# by state
p + geom_bar() + aes(PPSTATEN, fill = Q11_q) + coord_flip() + ggtitle("By state")

# by house type
p + geom_bar(position = "fill") + aes(fill = PPHOUSE) + ggtitle("By house type")

# by internet availability
p + geom_bar(position = "fill") + aes(fill = PPNET) + ggtitle("By internet availability")

```



## Q20. How effective do you think the influenza vaccine is in protecting people from becoming sick with influenza?

```{r}

```

```{r}

```

```{r}

```






